version: 2.0.{build}

image: Visual Studio 2022

services: 
- docker

init:
- net start MSSQL$SQL2019

build_script:
- cmd: >-
    dotnet build KnightBus.sln --configuration Release

before_test:
- docker pull redis
- docker run -d -p 6379:6379 --name redis6379 redis
- docker run -d -p 4222:4222 nats:latest
- docker run -d -p 10000:10000 -p 10001:10001 mcr.microsoft.com/azure-storage/azurite

test_script:
- cmd: >-
    dotnet format --verify-no-changes --no-restore --verbosity diagnostic
    dotnet test knightbus/tests/KnightBus.Core.Tests.Unit/KnightBus.Core.Tests.Unit.csproj --logger:Appveyor

    dotnet test knightbus/tests/KnightBus.Host.Tests.Unit/KnightBus.Host.Tests.Unit.csproj --logger:Appveyor

    dotnet test knightbus-azurestorage/tests/KnightBus.Azure.Storage.Tests.Unit/KnightBus.Azure.Storage.Tests.Unit.csproj --logger:Appveyor
    
    dotnet test knightbus-azurestorage/tests/KnightBus.Azure.Storage.Tests.Integration/KnightBus.Azure.Storage.Tests.Integration.csproj --logger:Appveyor

    dotnet test knightbus-sqlserver/tests/KnightBus.SqlServer.Tests.Integration/KnightBus.SqlServer.Tests.Integration.csproj --logger:Appveyor
    
    dotnet test knightbus-schedule/tests/KnightBus.Schedule.Tests.Unit/KnightBus.Schedule.Tests.Unit.csproj --logger:Appveyor

    dotnet test knightbus-redis/tests/KnightBus.Redis.Tests.Unit/KnightBus.Redis.Tests.Unit.csproj --logger:Appveyor

    dotnet test knightbus-redis/tests/KnightBus.Redis.Tests.Integration/KnightBus.Redis.Tests.Integration.csproj --logger:Appveyor

    dotnet test knightbus-nats/tests/KnightBus.Nats.Tests.Unit/KnightBus.Nats.Tests.Unit.csproj --logger:Appveyor

artifacts:
- path: '**\bin\Release\*.nupkg'

deploy:
- provider: NuGet
  api_key:
    secure: RKEYTNMN/9sZ7QvMGBK9EyDOkq8qmWiYAU1zlNaG+pzOZqoDLwcMDT//vM3jpHCl
  on:
    branch: master
